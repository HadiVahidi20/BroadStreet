<!--
  Broadstreet Players (Google Sheets) - GoHighLevel Custom HTML Snippet

  How to use:
  1) Paste this entire block into a GHL "Custom HTML" element.
  2) Set the CONFIG values below.
-->

<style>
  .bs-players { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  .bs-players h2 { margin: 0 0 16px; font-size: 24px; }
  .bs-players-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
  .bs-player-card { border: 1px solid rgba(0,0,0,0.1); border-radius: 12px; overflow: hidden; background: #fff; text-align: center; }
  .bs-player-img { width: 100%; aspect-ratio: 3/4; object-fit: cover; background: #f0f0f0; display: block; }
  .bs-player-body { padding: 12px 14px 16px; }
  .bs-player-pos { font-size: 12px; opacity: 0.6; margin-bottom: 4px; }
  .bs-player-name { font-size: 16px; font-weight: 700; margin: 0 0 6px; }
  .bs-player-stats { font-size: 11px; opacity: 0.6; }
  .bs-player-filter { margin-bottom: 16px; text-align: center; }
  .bs-player-filter select { padding: 10px 36px 10px 16px; font-size: 15px; border: 2px solid #e0e0e0; border-radius: 8px; appearance: none; background: #fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='%23666'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E") no-repeat right 10px center; cursor: pointer; }
  @media (max-width: 980px) { .bs-players-grid { grid-template-columns: repeat(3, 1fr); } }
  @media (max-width: 640px) { .bs-players-grid { grid-template-columns: repeat(2, 1fr); } }
</style>

<section class="bs-players" data-bs-players>
  <h2>1st XV Squad</h2>
  <div class="bs-player-filter">
    <select data-bs-player-filter>
      <option value="all">All Players</option>
      <option value="forward">Forwards</option>
      <option value="back">Backs</option>
    </select>
  </div>
  <div class="bs-players-grid" data-bs-players-grid><p style="opacity:.7">Loading squad...</p></div>
</section>

<script>
(function () {
  var CONFIG = {
    apiKey: "AIzaSyDeLiOcwEJuu8sCt6UjN74-Q9pvNljeoq4",
    sheetId: "1DT5Xti6N6uc9XgXJENQuF7B29uCAVwEQYQX3F6WRVc0",
    range: "players!A1:Z",
    defaultImage: "",
  };

  function esc(s) { return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"); }
  function normalizeHeader(h) { return String(h||"").trim().toLowerCase().replace(/\s+/g,"_"); }

  function rowsToObjects(values) {
    if (!Array.isArray(values)||values.length<2) return [];
    var headers=values[0].map(normalizeHeader), out=[];
    for (var i=1;i<values.length;i++) {
      var row=values[i]; if(!row||row.every(function(c){return String(c||"").trim()==="";})) continue;
      var obj={}; for(var c=0;c<headers.length;c++){if(!headers[c]) continue; obj[headers[c]]=row[c]!=null?row[c]:"";} out.push(obj);
    }
    return out;
  }

  function getGroup(pos) {
    if (/prop|hooker|lock|flanker|number.?8/i.test(pos)) return "forward";
    if (/scrum|fly|centre|wing|fullback|half/i.test(pos)) return "back";
    return "";
  }

  function renderCard(p) {
    var img = p.image ? esc(p.image) : (CONFIG.defaultImage || "");
    var imgTag = img ? '<img class="bs-player-img" src="'+img+'" alt="'+esc(p.name)+'">' : '<div class="bs-player-img" style="background:#ddd;"></div>';
    var stats = [];
    if (p.height) stats.push("Height: "+esc(p.height));
    if (p.weight) stats.push("Weight: "+esc(p.weight));
    if (p.age) stats.push("Age: "+esc(p.age));
    if (p.caps) stats.push("Caps: "+esc(p.caps));

    return '<div class="bs-player-card" data-group="'+esc(getGroup(p.position))+'">' +
      imgTag +
      '<div class="bs-player-body">' +
        '<div class="bs-player-pos">'+esc(p.number)+(p.number&&p.position?" &bull; ":"")+esc(p.position)+'</div>' +
        '<div class="bs-player-name">'+esc(p.name)+'</div>' +
        (stats.length ? '<div class="bs-player-stats">'+stats.join(" &bull; ")+'</div>' : '') +
      '</div></div>';
  }

  async function init() {
    var root = document.querySelector("[data-bs-players]");
    if (!root) return;
    try {
      var url = "https://sheets.googleapis.com/v4/spreadsheets/"+encodeURIComponent(CONFIG.sheetId)+"/values/"+encodeURIComponent(CONFIG.range)+"?key="+encodeURIComponent(CONFIG.apiKey)+"&majorDimension=ROWS";
      var resp = await fetch(url, {headers:{accept:"application/json"}});
      if (!resp.ok) throw new Error(resp.status);
      var players = rowsToObjects((await resp.json()).values);
      // Filter to 1st XV
      players = players.filter(function(p){return !p.team||p.team==="1st XV";});
      if (!players.length) return;

      var grid = root.querySelector("[data-bs-players-grid]");
      if (grid) grid.innerHTML = players.map(renderCard).join("");

      // Filter
      var select = root.querySelector("[data-bs-player-filter]");
      if (select) {
        select.addEventListener("change", function() {
          var val = this.value;
          var cards = grid.querySelectorAll(".bs-player-card");
          cards.forEach(function(c) {
            c.style.display = (val==="all"||c.getAttribute("data-group")===val) ? "" : "none";
          });
        });
      }
    } catch(e) { try{console.error(e);}catch(x){} }
  }

  if (document.readyState==="loading") document.addEventListener("DOMContentLoaded",init); else init();
})();
</script>
